---
title: "Preparación de datos. Tesis pregrado sociología."
author: "Sebastián Cortinez"
date: "30-03-2021"
output: html_document
---


```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
options(scipen=999) # valores sin notación científica
#install.packages("pacman")
library(pacman)
#detach("package:memisc", unload = TRUE)
pacman::p_load(dplyr, sjmisc, car, sjlabelled,labelled, stargazer,kableExtra,corrplot,sessioninfo,readxl,pander,xtable, tidyverse, extrafont, ggplot2, forcats, ggpubr, naniar,haven, devtools,summarytools,webshot,poLCA)
#devtools::install_github("melff/memisc",subdir="pkg")
```

# Cargar base de datos 2000

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
cep_2000 <- read_sav("../Input/Data/2000/Encuesta_CEP_2000/Encuesta_CEP_39.sav") #Leer base sav

dim(cep_2000)
find_var(data = cep_2000,"pobres")
find_var(data = cep_2000,"éxito económico")
find_var(data = cep_2000,"edad")
find_var(data = cep_2000,"hogar")
find_var(data = cep_2000,"escala")
find_var(data = cep_2000,"identifica") 
find_var(data = cep_2000,"TE.21B") 

######## falta encontrar pueblo originario

proc_cep_2000 <- cep_2000 %>% dplyr::select(te2a, # percepcion merit ESFUERZOS
                          te2b, # percepcion merit INTELIGENCIA Y CAPACIDADES
                          te15a, # preferencias merit RESPONSABILIDAD 
                          te15b, # preferencias merit AÑOS DEDICADOS A EDUCACION
                          te15f, # preferencias merit LO BIEN QUE TRABAJA
                          te21a,  # Att pobreza 1ra
                          te21b, # Att pobreza 2da
                          te20a, # Att riqueza 1ra
                          te20b, # Att riqueza 2da
                          dat_1,# sexo
                          dat_2, # edad
                          dat_24, # tramo ingresos sujeto
                          te12, # ESS
                          p7,  # posición politica
                          dat_6) # nivel educacional

```

## Codificación variables dependientes (atribuciones de pobreza y riqueza)

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}

#### Atribuciones de pobreza ####

## recode 
frq(proc_cep_2000$te21a)
frq(proc_cep_2000$te21b)

proc_cep_2000$te21a <- car::recode(proc_cep_2000$te21a,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11,88,99)=11")
proc_cep_2000$te21b <- car::recode(proc_cep_2000$te21b,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11,88,99)=11")

## etiquetado

proc_cep_2000 <- proc_cep_2000 %>% dplyr::rename("at_pobreza1"=te21a, # att pobreza respuesta 1
                                    "at_pobreza2" =te21b) # att pobreza respuesta 2

get_label(proc_cep_2000$at_pobreza1)
proc_cep_2000$at_pobreza1 <- set_label(x = proc_cep_2000$at_pobreza1,label = "Atribuciones pobreza primera opción")

get_label(proc_cep_2000$at_pobreza2)
proc_cep_2000$at_pobreza2 <- set_label(x = proc_cep_2000$at_pobreza2,label = "Atribuciones pobreza segunda opción")

## Etiquetar valores

proc_cep_2000$at_pobreza1<-as.character(proc_cep_2000$at_pobreza1)
typeof(proc_cep_2000$at_pobreza1)
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 1] = "La mala suerte"
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 2] = "La flojera y falta de iniciativa"
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 3] = "La falta de educación"
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 4] = "La falta de ayuda económica del gobierno"
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 5] = "Los vicios y el alcoholismo"
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 6] = "Las malas políticas econ. del gobierno"
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 7] = "La falta de generocidad de los que tienen más"
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 8] = "Las pocas oportunidades de empleo"
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 9] = "Porque los padres también eran pobres"
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 10] = "Los abusos o injusticias del sistema económico"
proc_cep_2000$at_pobreza1[proc_cep_2000$at_pobreza1 == 11] = "NS/NR"

# si se quiere ordenar: 
proc_cep_2000$at_pobreza1 = factor(proc_cep_2000$at_pobreza1,
                    levels=c("La mala suerte", "La flojera y falta de iniciativa", "La falta de educación","La falta de ayuda económica del gobierno","Los vicios y el alcoholismo","Las malas políticas econ. del gobierno","La falta de generocidad de los que tienen más","Las pocas oportunidades de empleo","Porque los padres también eran pobres","Los abusos o injusticias del sistema económico","NS/NR"))
frq(proc_cep_2000$at_pobreza1)

proc_cep_2000$at_pobreza2<-as.character(proc_cep_2000$at_pobreza2)
typeof(proc_cep_2000$at_pobreza2)
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 1] = "La mala suerte"
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 2] = "La flojera y falta de iniciativa"
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 3] = "La falta de educación"
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 4] = "La falta de ayuda económica del gobierno"
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 5] = "Los vicios y el alcoholismo"
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 6] = "Las malas políticas econ. del gobierno"
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 7] = "La falta de generocidad de los que tienen más"
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 8] = "Las pocas oportunidades de empleo"
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 9] = "Porque los padres también eran pobres"
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 10] = "Los abusos o injusticias del sistema económico"
proc_cep_2000$at_pobreza2[proc_cep_2000$at_pobreza2 == 11] = "NS/NR"

proc_cep_2000$at_pobreza2 = factor(proc_cep_2000$at_pobreza2,
                    levels=c("La mala suerte", "La flojera y falta de iniciativa", "La falta de educación","La falta de ayuda económica del gobierno","Los vicios y el alcoholismo","Las malas políticas econ. del gobierno","La falta de generocidad de los que tienen más","Las pocas oportunidades de empleo","Porque los padres también eran pobres","Los abusos o injusticias del sistema económico","NS/NR"))
frq(proc_cep_2000$at_pobreza2)

#### Atribuciones de riqueza ####

## recode 
frq(proc_cep_2000$te20a)
frq(proc_cep_2000$te20b)


proc_cep_2000$te20a <- car::recode(proc_cep_2000$te20a,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11)=11;c(12,88,99)=12")
proc_cep_2000$te20b <- car::recode(proc_cep_2000$te20b,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11)=11;c(12,88,99)=12")

## etiquetado
proc_cep_2000 <- proc_cep_2000 %>% dplyr::rename("at_riqueza1"=te20a, # att riqueza respuesta 1
                                    "at_riqueza2" =te20b) # att riqueza respuesta 2

get_label(proc_cep_2000$at_riqueza1)
proc_cep_2000$at_riqueza1 <- set_label(x = proc_cep_2000$at_riqueza1,label = "Atribuciones riqueza primera opción")

get_label(proc_cep_2000$at_riqueza2)
proc_cep_2000$at_riqueza2 <- set_label(x = proc_cep_2000$at_riqueza2,label = "Atribuciones riqueza segunda opción")

## Etiquetar valores

proc_cep_2000$at_riqueza1<-as.character(proc_cep_2000$at_riqueza1)
typeof(proc_cep_2000$at_riqueza1)
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 1] = "La iniciativa personal"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 2] = "La suerte"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 3] = "La fe en dios"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 4] = "El trabajo responsable"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 5] = "Los contactos o 'pitutos' (parientes, amigos)"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 6] = "El nivel educacional alcanzado"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 7] = "La situación económica de los padres"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 8] = "Las ayuda económica del Estado"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 9] = "Las políticas económicas del gobierno"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 10] = "Tener una familia unida que apoya"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 11] = "Haciendo dinero a la mala, con manejos deshonestos"
proc_cep_2000$at_riqueza1[proc_cep_2000$at_riqueza1 == 12] = "NS/NR"

# si se quiere ordenar: 
proc_cep_2000$at_riqueza1 = factor(proc_cep_2000$at_riqueza1,
                    levels=c( "La iniciativa personal","La suerte","La fe en dios","El trabajo responsable","Los contactos o 'pitutos' (parientes, amigos)","El nivel educacional alcanzado","La situación económica de los padres","Las ayuda económica del Estado","Las políticas económicas del gobierno","Tener una familia unida que apoya","Haciendo dinero a la mala, con manejos deshonestos","NS/NR"))
frq(proc_cep_2000$at_riqueza1)

proc_cep_2000$at_riqueza2<-as.character(proc_cep_2000$at_riqueza2)
typeof(proc_cep_2000$at_riqueza2)
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 1] = "La iniciativa personal"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 2] = "La suerte"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 3] = "La fe en dios"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 4] = "El trabajo responsable"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 5] = "Los contactos o 'pitutos' (parientes, amigos)"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 6] = "El nivel educacional alcanzado"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 7] = "La situación económica de los padres"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 8] = "Las ayuda económica del Estado"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 9] = "Las políticas económicas del gobierno"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 10] = "Tener una familia unida que apoya"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 11] = "Haciendo dinero a la mala, con manejos deshonestos"
proc_cep_2000$at_riqueza2[proc_cep_2000$at_riqueza2 == 12] = "NS/NR"
proc_cep_2000$at_riqueza2 = factor(proc_cep_2000$at_riqueza2,
                    levels=c( "La iniciativa personal","La suerte","La fe en dios","El trabajo responsable","Los contactos o 'pitutos' (parientes, amigos)","El nivel educacional alcanzado","La situación económica de los padres","Las ayuda económica del Estado","Las políticas económicas del gobierno","Tener una familia unida que apoya","Haciendo dinero a la mala, con manejos deshonestos","NS/NR"))
frq(proc_cep_2000$at_riqueza2)

```

## Codificación variables independientes

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
#### Percepcion merit ####

## recode 
frq(proc_cep_2000$te2a)
frq(proc_cep_2000$te2b)

proc_cep_2000$te2a <- recode(proc_cep_2000$te2a, "c(8,9)=NA")
proc_cep_2000$te2b <- recode(proc_cep_2000$te2b, "c(8,9)=NA")

proc_cep_2000$te2a <- car::recode(proc_cep_2000$te2a, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2000$te2b <- car::recode(proc_cep_2000$te2b, "1=5;2=4;3=3;4=2;5=1")

proc_cep_2000$te2a<-as.numeric(proc_cep_2000$te2a)
proc_cep_2000$te2b<-as.numeric(proc_cep_2000$te2b)

## etiquetado
proc_cep_2000 <- proc_cep_2000 %>% dplyr::rename("percep_esfuerzos"=te2a, # percepcion meritocracia esfuerzo
                                    "percep_inteligencia" =te2b) # percepcion meritocracia inteligencia y capacidades (talento)

### Re etiquetar valores

### proc_cep_2000$percep_esfuerzos <- sjlabelled::set_labels(proc_cep_2000$percep_esfuerzos,
###            labels=c( "Muy en desacuerdo"=1,"En desacuerdo"=2,"Ni de acuerdo ni en desacuerdo"=3,
###                      "De acuerdo"=4,"Muy de acuerdo"=5))
### proc_cep_2000$percep_inteligencia <- sjlabelled::set_labels(proc_cep_2000$percep_inteligencia,
###            labels=c( "Muy en desacuerdo"=1,"En desacuerdo"=2,"Ni de acuerdo ni en desacuerdo"=3,
###                      "De acuerdo"=4,"Muy de acuerdo"=5))

get_label(proc_cep_2000$percep_esfuerzos)
proc_cep_2000$percep_esfuerzos <- set_label(x = proc_cep_2000$percep_esfuerzos,label = "Percepcion de merito: esfuerzo")

get_label(proc_cep_2000$percep_inteligencia)
proc_cep_2000$percep_inteligencia <- set_label(x = proc_cep_2000$percep_inteligencia,label = "Percepcion de merito: inteligencia y capacidades")

#### Preferencias merit ####

## recode 
frq(proc_cep_2000$te15a)
frq(proc_cep_2000$te15b)
frq(proc_cep_2000$te15f)

proc_cep_2000$te15a <- recode(proc_cep_2000$te15a, "c(8,9)=NA")
proc_cep_2000$te15b <- recode(proc_cep_2000$te15b, "c(8,9)=NA")
proc_cep_2000$te15f <- recode(proc_cep_2000$te15f, "c(8,9)=NA")

proc_cep_2000$te15a <- car::recode(proc_cep_2000$te15a, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2000$te15b <- car::recode(proc_cep_2000$te15b, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2000$te15f <- car::recode(proc_cep_2000$te15f, "1=5;2=4;3=3;4=2;5=1")

proc_cep_2000$te15a<-as.numeric(proc_cep_2000$te15a)
proc_cep_2000$te15b<-as.numeric(proc_cep_2000$te15b)
proc_cep_2000$te15f<-as.numeric(proc_cep_2000$te15f)

## etiquetado
proc_cep_2000 <- proc_cep_2000 %>% dplyr::rename("pref_responsabilidad"=te15a, # preferencia meritocracia responsabildad
                                    "pref_educacion" =te15b, # preferencia meritocracia años educacion
                                    "pref_trabajo" =te15f) # preferencia meritocracia trabajo bien realizado

### Re etiquetar valores

### proc_cep_2000$pref_responsabilidad <- sjlabelled::set_labels(proc_cep_2000$pref_responsabilidad,
###             labels=c( "Sin importancia alguna"=1,"No muy importante"=2,"Bastante importante"=3,
###                       "Muy importante"=4,"Esencial"=5))
### proc_cep_2000$pref_educacion <- sjlabelled::set_labels(proc_cep_2000$pref_educacion,
###             labels=c( "Sin importancia alguna"=1,"No muy importante"=2,"Bastante importante"=3,
###                       "Muy importante"=4,"Esencial"=5))
### proc_cep_2000$pref_trabajo <- sjlabelled::set_labels(proc_cep_2000$pref_trabajo,
###             labels=c( "Sin importancia alguna"=1,"No muy importante"=2,"Bastante importante"=3,
###                       "Muy importante"=4,"Esencial"=5))

get_label(proc_cep_2000$pref_responsabilidad)
proc_cep_2000$pref_responsabilidad <- set_label(x = proc_cep_2000$pref_responsabilidad,label = "Preferencia meritocracia: responsabilidad")

get_label(proc_cep_2000$pref_educacion)
proc_cep_2000$pref_educacion <- set_label(x = proc_cep_2000$pref_educacion,label = "Preferencia meritocracia: educacion")

get_label(proc_cep_2000$pref_trabajo)
proc_cep_2000$pref_trabajo <- set_label(x = proc_cep_2000$pref_trabajo,label = "Preferencia meritocracia: buen trabajo")

#### sexo ####

frq(proc_cep_2000$dat_1)

proc_cep_2000$dat_1 <- car::recode(proc_cep_2000$dat_1, "1=0;2=1")

proc_cep_2000$dat_1 <- sjlabelled::set_labels(proc_cep_2000$dat_1,
            labels=c( "Hombre"=0,"Mujer"=1))

proc_cep_2000 <- dplyr::rename(proc_cep_2000,"sexo"=dat_1)

get_label(proc_cep_2000$sexo)

proc_cep_2000$sexo <- as.factor(proc_cep_2000$sexo)
proc_cep_2000$sexo <- set_label(x = proc_cep_2000$sexo,label = "Sexo")
frq(proc_cep_2000$sexo)

#### edad ####

frq(proc_cep_2000$dat_2)

proc_cep_2000 <- dplyr::rename(proc_cep_2000,"edad"=dat_2)

get_label(proc_cep_2000$edad)

proc_cep_2000$edad <- set_label(x = proc_cep_2000$edad,label = "Edad")

#### ingreso ####

## recode
frq(proc_cep_2000$dat_24)

proc_cep_2000$dat_24<-as.numeric(proc_cep_2000$dat_24)

proc_cep_2000$dat_24 <- car::Recode(proc_cep_2000$dat_24, "1:5=1;6:8=2;9=3;10:14=4;19:99=5")

## etiquetado
proc_cep_2000 <- proc_cep_2000 %>% dplyr::rename("tramo_ingresos"=dat_24) # Ingreso en tramos

proc_cep_2000$tramo_ingresos<-as.factor(proc_cep_2000$tramo_ingresos)
proc_cep_2000$tramo_ingresos <- sjlabelled::set_labels(proc_cep_2000$tramo_ingresos,
            labels=c( "Menor al sueldo mínimo"=1,
                      "210 mil a 390 mil"=2,
                      "391 mil a 600 mil"=3,
                      "Más de 601 mil"=4,
                      "NS/NR"=5))

get_label(proc_cep_2000$tramo_ingresos)
proc_cep_2000$tramo_ingresos <- set_label(x = proc_cep_2000$tramo_ingresos,label = "Tramo ingresos entrevistado")

frq(proc_cep_2000$tramo_ingresos)

#### Estatus Social Subjetivo ####

## recode
frq(proc_cep_2000$te12)

## etiquetado
proc_cep_2000 <- proc_cep_2000 %>% dplyr::rename("ESS"=te12) # Estatus social subjetivo

get_label(proc_cep_2000$ESS)
proc_cep_2000$ESS <- set_label(x = proc_cep_2000$ESS,label = "Escala ESS")

proc_cep_2000$ESS<-as.numeric(proc_cep_2000$ESS)
frq(proc_cep_2000$ESS)

#### Identificacion politica ####

## recode
frq(proc_cep_2000$p7)

proc_cep_2000$p7<-car::Recode(proc_cep_2000$p7, "1:2=1;3=2;4:5=3;6:9=4")

## etiquetado
proc_cep_2000 <- proc_cep_2000 %>% dplyr::rename("id_politica"=p7) # Identificacion politica

proc_cep_2000$id_politica <- factor(proc_cep_2000$id_politica, labels=c("Derecha","Centro","Izquierda","NS/NR/Ninguno"))

get_label(proc_cep_2000$id_politica)
proc_cep_2000$id_politica <- set_label(x = proc_cep_2000$id_politica,label = "Identificación política")

#### nivel educacional ####

## recode
frq(proc_cep_2000$dat_6)
proc_cep_2000$dat_6 <- recode(proc_cep_2000$dat_6, "c(9)=NA")

proc_cep_2000$dat_6<-car::Recode(proc_cep_2000$dat_6, "1:3=1;4:5=2;6:10=3")

## etiquetado
proc_cep_2000 <- proc_cep_2000 %>% dplyr::rename("nivel_educ"=dat_6) # Nivel educacional

proc_cep_2000$nivel_educ <- factor(proc_cep_2000$nivel_educ, labels=c("Básica","Media","Superior"))

get_label(proc_cep_2000$nivel_educ)
proc_cep_2000$nivel_educ <- set_label(x = proc_cep_2000$nivel_educ,label = "Nivel educacional")


proc_cep_2000<-as.data.frame(proc_cep_2000)
stargazer(proc_cep_2000, type="text")


proc_cep_2000 <- proc_cep_2000 %>%
  mutate(percep_ambicion = NA)

proc_cep_2000 <- proc_cep_2000 %>%
  mutate(año = 2000)
```

**Descriptivos**

```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
# Descriptivos 
sum(is.na(proc_cep_2000))
stargazer(proc_cep_2000, type="text") ## No hay demasiados NA's


## Guardar tabla stargazer
stargazer(proc_cep_2000, type="html",  out = "../Output/Descriptivos_proc_data/descr_tab2000.html")
webshot("descr_tab2000.html","descr_tab2000.png")

## Otra tabla de descriptivos
view(dfSummary(proc_cep_2000, headings=FALSE))
```
Guardar datos
```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
# Guardar bbdd

save(proc_cep_2000,file = "../Input/Data_proc/2000/proc_cep_2000.RData")
```

# Cargar base de datos 2009

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}

cep_2009 <- sjlabelled::read_spss("../Input/Data/2009/Encuesta_CEP_2009/Encuesta_CEP_59.sav") #Leer base sav

find_var(data = cep_2009,"tramo")

proc_cep_2009 <- cep_2009 %>% dplyr::select(TE2P11_C, # percepcion merit EDUCACION (talento (inteligencia y capacidad))
                          TE2P11_D, # percepcion merit AMBICION
                          TE2P11_E, # percepcion merit TRABAJO DURO (esfuerzo)
                          TE2P22_A, # preferencias merit RESPONSABILIDAD 
                          TE2P22_B, # preferencias merit AÑOS DEDICADOS A EDUCACION
                          TE2P22_E, # preferencias merit LO BIEN QUE TRABAJA
                          TE2P01_1,  # Att pobreza 1ra
                          TE2P01_2, # Att pobreza 2da
                          TE2P02_1, # Att riqueza 1ra
                          TE2P02_2, # Att riqueza 2da
                          DDP01,# sexo
                          DDP02, # edad
                          DDP25, # tramo ingresos sujeto
                          TE2P20_A, # ESS
                          MBP16,# posición politica
                          DDP06_ni) # Nivel educacional

```

## Codificación variables dependientes

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}

#### Atribuciones de pobreza ####

## recode 
frq(proc_cep_2009$TE2P01_1)
frq(proc_cep_2009$TE2P01_2)


proc_cep_2009$TE2P01_1 <- car::recode(proc_cep_2009$TE2P01_1,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11,88,99)=11")
proc_cep_2009$TE2P01_2 <- car::recode(proc_cep_2009$TE2P01_2,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11,88,99)=11")


## etiquetado
proc_cep_2009 <- proc_cep_2009 %>% dplyr::rename("at_pobreza1"=TE2P01_1, # att pobreza respuesta 1
                                          "at_pobreza2" =TE2P01_2) # att pobreza respuesta 2

get_label(proc_cep_2009$at_pobreza1)
proc_cep_2009$at_pobreza1 <- set_label(x = proc_cep_2009$at_pobreza1,label = "Atribuciones pobreza primera opción")

get_label(proc_cep_2009$at_pobreza2)
proc_cep_2009$at_pobreza2 <- set_label(x = proc_cep_2009$at_pobreza2,label = "Atribuciones pobreza segunda opción")

proc_cep_2009$at_pobreza1<-as.character(proc_cep_2009$at_pobreza1)
typeof(proc_cep_2009$at_pobreza1)
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 1] = "La mala suerte"
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 2] = "La flojera y falta de iniciativa"
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 3] = "La falta de educación"
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 4] = "La falta de ayuda económica del gobierno"
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 5] = "Los vicios y el alcoholismo"
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 6] = "Las malas políticas econ. del gobierno"
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 7] = "La falta de generocidad de los que tienen más"
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 8] = "Las pocas oportunidades de empleo"
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 9] = "Porque los padres también eran pobres"
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 10] = "Los abusos o injusticias del sistema económico"
proc_cep_2009$at_pobreza1[proc_cep_2009$at_pobreza1 == 11] = "NS/NR"

# si se quiere ordenar: 
proc_cep_2009$at_pobreza1 = factor(proc_cep_2009$at_pobreza1,
                    levels=c("La mala suerte", "La flojera y falta de iniciativa", "La falta de educación","La falta de ayuda económica del gobierno","Los vicios y el alcoholismo","Las malas políticas econ. del gobierno","La falta de generocidad de los que tienen más","Las pocas oportunidades de empleo","Porque los padres también eran pobres","Los abusos o injusticias del sistema económico","NS/NR"))
frq(proc_cep_2009$at_pobreza1)

proc_cep_2009$at_pobreza2<-as.character(proc_cep_2009$at_pobreza2)
typeof(proc_cep_2009$at_pobreza2)
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 1] = "La mala suerte"
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 2] = "La flojera y falta de iniciativa"
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 3] = "La falta de educación"
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 4] = "La falta de ayuda económica del gobierno"
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 5] = "Los vicios y el alcoholismo"
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 6] = "Las malas políticas econ. del gobierno"
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 7] = "La falta de generocidad de los que tienen más"
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 8] = "Las pocas oportunidades de empleo"
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 9] = "Porque los padres también eran pobres"
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 10] = "Los abusos o injusticias del sistema económico"
proc_cep_2009$at_pobreza2[proc_cep_2009$at_pobreza2 == 11] = "NS/NR"

proc_cep_2009$at_pobreza2 = factor(proc_cep_2009$at_pobreza2,
                    levels=c("La mala suerte", "La flojera y falta de iniciativa", "La falta de educación","La falta de ayuda económica del gobierno","Los vicios y el alcoholismo","Las malas políticas econ. del gobierno","La falta de generocidad de los que tienen más","Las pocas oportunidades de empleo","Porque los padres también eran pobres","Los abusos o injusticias del sistema económico","NS/NR"))
frq(proc_cep_2009$at_pobreza2)

#### Atribuciones de riqueza ####

## recode 
frq(proc_cep_2009$TE2P02_1)
frq(proc_cep_2009$TE2P02_2)


proc_cep_2009$TE2P02_1 <- car::recode(proc_cep_2009$TE2P02_1,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11)=11;c(12,88,99)=12")
proc_cep_2009$TE2P02_2 <- car::recode(proc_cep_2009$TE2P02_2,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11)=11;c(12,88,99)=12")


## etiquetado
proc_cep_2009 <- proc_cep_2009 %>% dplyr::rename("at_riqueza1"=TE2P02_1, # att riqueza respuesta 1
                                          "at_riqueza2" =TE2P02_2) # att riqueza respuesta 2

get_label(proc_cep_2009$at_riqueza1)
proc_cep_2009$at_riqueza1 <- set_label(x = proc_cep_2009$at_riqueza1,label = "Atribuciones riqueza primera opción")

get_label(proc_cep_2009$at_riqueza2)
proc_cep_2009$at_riqueza2 <- set_label(x = proc_cep_2009$at_riqueza2,label = "Atribuciones riqueza segunda opción")

## Etiquetar valores

proc_cep_2009$at_riqueza1<-as.character(proc_cep_2009$at_riqueza1)
typeof(proc_cep_2009$at_riqueza1)
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 1] = "La iniciativa personal"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 2] = "La suerte"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 3] = "La fe en dios"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 4] = "El trabajo responsable"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 5] = "Los contactos o 'pitutos' (parientes, amigos)"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 6] = "El nivel educacional alcanzado"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 7] = "La situación económica de los padres"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 8] = "Las ayuda económica del Estado"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 9] = "Las políticas económicas del gobierno"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 10] = "Tener una familia unida que apoya"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 11] = "Haciendo dinero a la mala, con manejos deshonestos"
proc_cep_2009$at_riqueza1[proc_cep_2009$at_riqueza1 == 12] = "NS/NR"

# si se quiere ordenar: 
proc_cep_2009$at_riqueza1 = factor(proc_cep_2009$at_riqueza1,
                    levels=c( "La iniciativa personal","La suerte","La fe en dios","El trabajo responsable","Los contactos o 'pitutos' (parientes, amigos)","El nivel educacional alcanzado","La situación económica de los padres","Las ayuda económica del Estado","Las políticas económicas del gobierno","Tener una familia unida que apoya","Haciendo dinero a la mala, con manejos deshonestos","NS/NR"))
frq(proc_cep_2009$at_riqueza1)

proc_cep_2009$at_riqueza2<-as.character(proc_cep_2009$at_riqueza2)
typeof(proc_cep_2009$at_riqueza2)
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 1] = "La iniciativa personal"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 2] = "La suerte"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 3] = "La fe en dios"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 4] = "El trabajo responsable"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 5] = "Los contactos o 'pitutos' (parientes, amigos)"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 6] = "El nivel educacional alcanzado"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 7] = "La situación económica de los padres"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 8] = "Las ayuda económica del Estado"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 9] = "Las políticas económicas del gobierno"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 10] = "Tener una familia unida que apoya"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 11] = "Haciendo dinero a la mala, con manejos deshonestos"
proc_cep_2009$at_riqueza2[proc_cep_2009$at_riqueza2 == 12] = "NS/NR"
proc_cep_2009$at_riqueza2 = factor(proc_cep_2009$at_riqueza2,
                    levels=c( "La iniciativa personal","La suerte","La fe en dios","El trabajo responsable","Los contactos o 'pitutos' (parientes, amigos)","El nivel educacional alcanzado","La situación económica de los padres","Las ayuda económica del Estado","Las políticas económicas del gobierno","Tener una familia unida que apoya","Haciendo dinero a la mala, con manejos deshonestos","NS/NR"))
frq(proc_cep_2009$at_riqueza2)


```

## Codificación variables independientes

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}

#### Percepcion merit ####

## recode 
frq(proc_cep_2009$TE2P11_C)
frq(proc_cep_2009$TE2P11_D)
frq(proc_cep_2009$TE2P11_E)

proc_cep_2009$TE2P11_D <- recode(proc_cep_2009$TE2P11_D, "c(8,9)=NA")
proc_cep_2009$TE2P11_E <- recode(proc_cep_2009$TE2P11_E, "c(8,9)=NA")
proc_cep_2009$TE2P11_C <- recode(proc_cep_2009$TE2P11_C, "c(8,9)=NA")

proc_cep_2009$TE2P11_D <- car::recode(proc_cep_2009$TE2P11_D, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2009$TE2P11_E <- car::recode(proc_cep_2009$TE2P11_E, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2009$TE2P11_C <- car::recode(proc_cep_2009$TE2P11_C, "1=5;2=4;3=3;4=2;5=1")

proc_cep_2009$TE2P11_D<-as.numeric(proc_cep_2009$TE2P11_D)
proc_cep_2009$TE2P11_E<-as.numeric(proc_cep_2009$TE2P11_E)
proc_cep_2009$TE2P11_C<-as.numeric(proc_cep_2009$TE2P11_C)

## etiquetado
proc_cep_2009 <- proc_cep_2009 %>% dplyr::rename("percep_esfuerzos"=TE2P11_E, # percepcion meritocracia esfuerzo
                                          "percep_inteligencia" =TE2P11_C, # percepcion meritocracia inteligencia y capacidades (talento)
                                          "percep_ambicion" =TE2P11_D) # percepcion meritocracia ambicion


get_label(proc_cep_2009$percep_esfuerzos)
proc_cep_2009$percep_esfuerzos <- set_label(x = proc_cep_2009$percep_esfuerzos,label = "Percepcion de merito esfuerzo")

get_label(proc_cep_2009$percep_inteligencia)
proc_cep_2009$percep_inteligencia <- set_label(x = proc_cep_2009$percep_inteligencia,label = "Percepcion de merito inteligencia y capacidades")

get_label(proc_cep_2009$percep_ambicion)
proc_cep_2009$percep_ambicion <- set_label(x = proc_cep_2009$percep_ambicion,label = "Percepcion de merito ambición")

#### Preferencias merit ####

## recode 
frq(proc_cep_2009$TE2P22_A)
frq(proc_cep_2009$TE2P22_B)
frq(proc_cep_2009$TE2P22_E)

proc_cep_2009$TE2P22_A <- recode(proc_cep_2009$TE2P22_A, "c(8,9)=NA")
proc_cep_2009$TE2P22_B <- recode(proc_cep_2009$TE2P22_B, "c(8,9)=NA")
proc_cep_2009$TE2P22_E <- recode(proc_cep_2009$TE2P22_E, "c(8,9)=NA")

proc_cep_2009$TE2P22_A <- car::recode(proc_cep_2009$TE2P22_A, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2009$TE2P22_B <- car::recode(proc_cep_2009$TE2P22_B, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2009$TE2P22_E <- car::recode(proc_cep_2009$TE2P22_E, "1=5;2=4;3=3;4=2;5=1")

proc_cep_2009$TE2P22_A<-as.numeric(proc_cep_2009$TE2P22_A)
proc_cep_2009$TE2P22_B<-as.numeric(proc_cep_2009$TE2P22_B)
proc_cep_2009$TE2P22_E<-as.numeric(proc_cep_2009$TE2P22_E)

## etiquetado
proc_cep_2009 <- proc_cep_2009 %>% dplyr::rename("pref_responsabilidad"=TE2P22_A, # preferencia meritocracia responsabildad
                                          "pref_educacion" =TE2P22_B, # preferencia meritocracia años educacion
                                          "pref_trabajo" =TE2P22_E) # preferencia meritocracia trabajo bien realizado 

get_label(proc_cep_2009$pref_responsabilidad)
proc_cep_2009$pref_responsabilidad <- set_label(x = proc_cep_2009$pref_responsabilidad,label = "Preferencia meritocracia: responsabilidad")

get_label(proc_cep_2009$pref_educacion)
proc_cep_2009$pref_educacion <- set_label(x = proc_cep_2009$pref_educacion,label = "Preferencia meritocracia: educacion")

get_label(proc_cep_2009$pref_trabajo)
proc_cep_2009$pref_trabajo <- set_label(x = proc_cep_2009$pref_trabajo,label = "Preferencia meritocracia: buen trabajo")

#### sexo ####

frq(proc_cep_2009$DDP01)

proc_cep_2009$DDP01 <- car::recode(proc_cep_2009$DDP01, "1=0;2=1")

proc_cep_2009$DDP01 <- sjlabelled::set_labels(proc_cep_2009$DDP01,
                                  labels=c( "Hombre"=0,
                                            "Mujer"=1))

proc_cep_2009 <- dplyr::rename(proc_cep_2009,"sexo"=DDP01)

get_label(proc_cep_2009$sexo)

proc_cep_2009$sexo <- as.factor(proc_cep_2009$sexo)
proc_cep_2009$sexo <- set_label(x = proc_cep_2009$sexo,label = "Sexo")
frq(proc_cep_2009$sexo)

#### edad ####

frq(proc_cep_2009$DDP02)
proc_cep_2009$DDP02 <- recode(proc_cep_2009$DDP02, "c(99)=NA")

proc_cep_2009 <- dplyr::rename(proc_cep_2009,"edad"=DDP02)

get_label(proc_cep_2009$edad)

proc_cep_2009$edad <- set_label(x = proc_cep_2009$edad,label = "Edad")

#### ingreso ####

## recode
frq(proc_cep_2009$DDP25)

proc_cep_2009$DDP25<-as.numeric(proc_cep_2009$DDP25)

proc_cep_2009$DDP25 <- car::Recode(proc_cep_2009$DDP25, "1:7=1;8:10=2;11=3;12:14=4;88:99=5")

## etiquetado
proc_cep_2009 <- proc_cep_2009 %>% dplyr::rename("tramo_ingresos"=DDP25) # Ingreso en tramos

proc_cep_2009$tramo_ingresos<-as.factor(proc_cep_2009$tramo_ingresos)
proc_cep_2009$tramo_ingresos <- sjlabelled::set_labels(proc_cep_2009$tramo_ingresos,
            labels=c( "Menor al sueldo mínimo"=1,
                      "Sueldo mínimo a 448 mil"=2,
                      "448 mil a 1 millón"=3,
                      "Más de un millón"=4,
                      "NS/NR"=5))

get_label(proc_cep_2009$tramo_ingresos)
proc_cep_2009$tramo_ingresos <- set_label(x = proc_cep_2009$tramo_ingresos,label = "Tramo ingresos entrevistado")

frq(proc_cep_2009$tramo_ingresos)

#### Estatus Social Subjetivo ####

## recode
frq(proc_cep_2009$TE2P20_A)
proc_cep_2009$TE2P20_A <- recode(proc_cep_2009$TE2P20_A, "c(88,99)=NA")


## etiquetado
proc_cep_2009 <- proc_cep_2009 %>% dplyr::rename("ESS"=TE2P20_A) # Estatus social subjetivo

get_label(proc_cep_2009$ESS)
proc_cep_2009$ESS <- set_label(x = proc_cep_2009$ESS,label = "Escala ESS")

proc_cep_2009$ESS<-as.numeric(proc_cep_2009$ESS)
frq(proc_cep_2009$ESS)

#### Identificacion politica ####

## recode
frq(proc_cep_2009$MBP16)

proc_cep_2009$MBP16<-car::Recode(proc_cep_2009$MBP16, "1:2=1;3=2;4:5=3;6:9=4")

## etiquetado
proc_cep_2009 <- proc_cep_2009 %>% dplyr::rename("id_politica"=MBP16) # Identificacion politica

proc_cep_2009$id_politica <- factor(proc_cep_2009$id_politica, labels=c("Derecha","Centro","Izquierda","NS/NR/Ninguno"))

get_label(proc_cep_2009$id_politica)
proc_cep_2009$id_politica <- set_label(x = proc_cep_2009$id_politica,label = "Identificación política")

#### nivel educacional ####

## recode
frq(proc_cep_2009$DDP06_ni)
proc_cep_2009$DDP06_ni <- recode(proc_cep_2009$DDP06_ni, "c(99)=NA")

proc_cep_2009$DDP06_ni<-car::Recode(proc_cep_2009$DDP06_ni, "0:2=1;3:4=2;5:9=3")

## etiquetado
proc_cep_2009 <- proc_cep_2009 %>% dplyr::rename("nivel_educ"=DDP06_ni) # Nivel educacional

proc_cep_2009$nivel_educ <- factor(proc_cep_2009$nivel_educ, labels=c("Básica","Media","Superior"))

get_label(proc_cep_2009$nivel_educ)
proc_cep_2009$nivel_educ <- set_label(x = proc_cep_2009$nivel_educ,label = "Nivel educacional")


proc_cep_2009<-as.data.frame(proc_cep_2009)
stargazer(proc_cep_2009, type="text")

# Agregamos la columna "año"
proc_cep_2009 <- proc_cep_2009 %>%
  mutate(año = 2009)
```

**Descriptivos** 

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}

# Descriptivos 

stargazer(proc_cep_2009, type="text") ## No hay demasiados NA's

## Guardar tabla stargazer
stargazer(proc_cep_2009, type="html",  out = "../Output/Descriptivos_proc_data/descr_tab2009.html")
webshot("descr_tab2009.html","descr_tab2009.png")

## Otra tabla de descriptivos
view(dfSummary(proc_cep_2009, headings=FALSE))

# Guardar bbdd
```
Guardar datos
```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
save(proc_cep_2009,file = "../Input/Data_proc/2009/proc_cep_2009.RData")
```

# Cargar base de datos 2019

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}


cep_2019 <- sjlabelled::read_spss("../Input/Data/2019/Encuesta_CEP_2019/Encuesta_CEP_83.sav") #Leer base sav

find_var(data = cep_2019,"viven")

proc_cep_2019 <- cep_2019 %>% dplyr::select(M2_P1_4, # percepcion merit EDUCACION (talento (inteligencia y capacidad))
                                            M2_P1_1, # percepcion merit AMBICION
                                            M2_P1_5, # percepcion merit TRABAJO DURO (esfuerzo)
                                            M2_P14_1, # preferencias merit RESPONSABILIDAD 
                                            M2_P14_2, # preferencias merit AÑOS DEDICADOS A EDUCACION
                                            M2_P14_4, # preferencias merit LO BIEN QUE TRABAJA
                                            MB_P18_1,  # Att pobreza 1ra
                                            MB_P18_2, # Att pobreza 2da
                                            MB_P19_1, # Att riqueza 1ra
                                            MB_P19_2, # Att riqueza 2da
                                            DS_P1,# sexo
                                            DS_P2_EXACTA, # edad
                                            DS_P38, # tramo ingresos sujeto
                                            M2_P13A, # ESS
                                            MB_P14,# posición politica
                                            DS_P4) # Nivel educacional

```

## Codificación variables dependientes

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}

#### Atribuciones de pobreza ####

## recode 
frq(proc_cep_2019$MB_P18_1)
frq(proc_cep_2019$MB_P18_2)
proc_cep_2019$MB_P18_2[is.na(proc_cep_2019$MB_P18_2)] <- 88

proc_cep_2019$MB_P18_1 <- car::recode(proc_cep_2019$MB_P18_1,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11,88,99)=11")
proc_cep_2019$MB_P18_2 <- car::recode(proc_cep_2019$MB_P18_2,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11,88,99)=11")

## etiquetado
proc_cep_2019 <- proc_cep_2019 %>% dplyr::rename("at_pobreza1"=MB_P18_1, # att pobreza respuesta 1
                                          "at_pobreza2" =MB_P18_2) # att pobreza respuesta 2

get_label(proc_cep_2019$at_pobreza1)
proc_cep_2019$at_pobreza1 <- set_label(x = proc_cep_2019$at_pobreza1,label = "Atribuciones pobreza primera opción")

get_label(proc_cep_2019$at_pobreza2)
proc_cep_2019$at_pobreza2 <- set_label(x = proc_cep_2019$at_pobreza2,label = "Atribuciones pobreza segunda opción")

proc_cep_2019$at_pobreza1<-as.character(proc_cep_2019$at_pobreza1)
typeof(proc_cep_2019$at_pobreza1)
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 1] = "La mala suerte"
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 2] = "La flojera y falta de iniciativa"
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 3] = "La falta de educación"
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 4] = "La falta de ayuda económica del gobierno"
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 5] = "Los vicios y el alcoholismo"
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 6] = "Las malas políticas econ. del gobierno"
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 7] = "La falta de generocidad de los que tienen más"
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 8] = "Las pocas oportunidades de empleo"
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 9] = "Porque los padres también eran pobres"
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 10] = "Los abusos o injusticias del sistema económico"
proc_cep_2019$at_pobreza1[proc_cep_2019$at_pobreza1 == 11] = "NS/NR"

# si se quiere ordenar: 
proc_cep_2019$at_pobreza1 = factor(proc_cep_2019$at_pobreza1,
                    levels=c("La mala suerte", "La flojera y falta de iniciativa", "La falta de educación","La falta de ayuda económica del gobierno","Los vicios y el alcoholismo","Las malas políticas econ. del gobierno","La falta de generocidad de los que tienen más","Las pocas oportunidades de empleo","Porque los padres también eran pobres","Los abusos o injusticias del sistema económico","NS/NR"))
frq(proc_cep_2019$at_pobreza1)

proc_cep_2019$at_pobreza2<-as.character(proc_cep_2019$at_pobreza2)
typeof(proc_cep_2019$at_pobreza2)
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 1] = "La mala suerte"
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 2] = "La flojera y falta de iniciativa"
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 3] = "La falta de educación"
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 4] = "La falta de ayuda económica del gobierno"
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 5] = "Los vicios y el alcoholismo"
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 6] = "Las malas políticas econ. del gobierno"
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 7] = "La falta de generocidad de los que tienen más"
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 8] = "Las pocas oportunidades de empleo"
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 9] = "Porque los padres también eran pobres"
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 10] = "Los abusos o injusticias del sistema económico"
proc_cep_2019$at_pobreza2[proc_cep_2019$at_pobreza2 == 11] = "NS/NR"

proc_cep_2019$at_pobreza2 = factor(proc_cep_2019$at_pobreza2,
                    levels=c("La mala suerte", "La flojera y falta de iniciativa", "La falta de educación","La falta de ayuda económica del gobierno","Los vicios y el alcoholismo","Las malas políticas econ. del gobierno","La falta de generocidad de los que tienen más","Las pocas oportunidades de empleo","Porque los padres también eran pobres","Los abusos o injusticias del sistema económico","NS/NR"))
frq(proc_cep_2019$at_pobreza2)


#### Atribuciones de riqueza ####

## recode 
frq(proc_cep_2019$MB_P19_1)
frq(proc_cep_2019$MB_P19_2)
proc_cep_2019$MB_P19_2[is.na(proc_cep_2019$MB_P19_2)] <- 88

proc_cep_2019$MB_P19_1 <- car::recode(proc_cep_2019$MB_P19_1,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11)=11;c(12,88,99)=12")
proc_cep_2019$MB_P19_2 <- car::recode(proc_cep_2019$MB_P19_2,"c(1)=1;c(2)=2;c(3)=3;c(4)=4;c(5)=5;c(6)=6;c(7)=7;c(8)=8;c(9)=9;c(10)=10;c(11)=11;c(12,88,99)=12")

## etiquetado
proc_cep_2019 <- proc_cep_2019 %>% dplyr::rename("at_riqueza1"=MB_P19_1, # att riqueza respuesta 1
                                          "at_riqueza2" =MB_P19_2) # att riqueza respuesta 2

get_label(proc_cep_2019$at_riqueza1)
proc_cep_2019$at_riqueza1 <- set_label(x = proc_cep_2019$at_riqueza1,label = "Atribuciones riqueza primera opción")

get_label(proc_cep_2019$at_riqueza2)
proc_cep_2019$at_riqueza2 <- set_label(x = proc_cep_2019$at_riqueza2,label = "Atribuciones riqueza segunda opción")

## Etiquetar valores

proc_cep_2019$at_riqueza1<-as.character(proc_cep_2019$at_riqueza1)
typeof(proc_cep_2019$at_riqueza1)
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 1] = "La iniciativa personal"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 2] = "La suerte"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 3] = "La fe en dios"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 4] = "El trabajo responsable"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 5] = "Los contactos o 'pitutos' (parientes, amigos)"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 6] = "El nivel educacional alcanzado"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 7] = "La situación económica de los padres"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 8] = "Las ayuda económica del Estado"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 9] = "Las políticas económicas del gobierno"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 10] = "Tener una familia unida que apoya"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 11] = "Haciendo dinero a la mala, con manejos deshonestos"
proc_cep_2019$at_riqueza1[proc_cep_2019$at_riqueza1 == 12] = "NS/NR"

# si se quiere ordenar: 
proc_cep_2019$at_riqueza1 = factor(proc_cep_2019$at_riqueza1,
                    levels=c( "La iniciativa personal","La suerte","La fe en dios","El trabajo responsable","Los contactos o 'pitutos' (parientes, amigos)","El nivel educacional alcanzado","La situación económica de los padres","Las ayuda económica del Estado","Las políticas económicas del gobierno","Tener una familia unida que apoya","Haciendo dinero a la mala, con manejos deshonestos","NS/NR"))
frq(proc_cep_2019$at_riqueza1)

proc_cep_2019$at_riqueza2<-as.character(proc_cep_2019$at_riqueza2)
typeof(proc_cep_2019$at_riqueza2)
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 1] = "La iniciativa personal"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 2] = "La suerte"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 3] = "La fe en dios"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 4] = "El trabajo responsable"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 5] = "Los contactos o 'pitutos' (parientes, amigos)"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 6] = "El nivel educacional alcanzado"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 7] = "La situación económica de los padres"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 8] = "Las ayuda económica del Estado"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 9] = "Las políticas económicas del gobierno"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 10] = "Tener una familia unida que apoya"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 11] = "Haciendo dinero a la mala, con manejos deshonestos"
proc_cep_2019$at_riqueza2[proc_cep_2019$at_riqueza2 == 12] = "NS/NR"
proc_cep_2019$at_riqueza2 = factor(proc_cep_2019$at_riqueza2,
                    levels=c( "La iniciativa personal","La suerte","La fe en dios","El trabajo responsable","Los contactos o 'pitutos' (parientes, amigos)","El nivel educacional alcanzado","La situación económica de los padres","Las ayuda económica del Estado","Las políticas económicas del gobierno","Tener una familia unida que apoya","Haciendo dinero a la mala, con manejos deshonestos","NS/NR"))
frq(proc_cep_2019$at_riqueza2)

```

## Codificación variables independientes

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
#### Percepcion merit ####

## recode 
frq(proc_cep_2019$M2_P1_5)
frq(proc_cep_2019$M2_P1_1)
frq(proc_cep_2019$M2_P1_4)

proc_cep_2019$M2_P1_1 <- recode(proc_cep_2019$M2_P1_1, "c(8,9)=NA")
proc_cep_2019$M2_P1_4 <- recode(proc_cep_2019$M2_P1_4, "c(8,9)=NA")
proc_cep_2019$M2_P1_5 <- recode(proc_cep_2019$M2_P1_5, "c(8,9)=NA")

proc_cep_2019$M2_P1_1 <- car::recode(proc_cep_2019$M2_P1_1, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2019$M2_P1_4 <- car::recode(proc_cep_2019$M2_P1_4, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2019$M2_P1_5 <- car::recode(proc_cep_2019$M2_P1_5, "1=5;2=4;3=3;4=2;5=1")

proc_cep_2019$M2_P1_1<-as.numeric(proc_cep_2019$M2_P1_1)
proc_cep_2019$M2_P1_4<-as.numeric(proc_cep_2019$M2_P1_4)
proc_cep_2019$M2_P1_5<-as.numeric(proc_cep_2019$M2_P1_5)

## etiquetado
proc_cep_2019 <- proc_cep_2019 %>% dplyr::rename("percep_inteligencia"=M2_P1_4, # percepcion meritocracia esfuerzo
                                          "percep_esfuerzos" =M2_P1_5, # percepcion meritocracia inteligencia y capacidades (talento)
                                          "percep_ambicion" =M2_P1_1) # percepcion meritocracia ambicion

get_label(proc_cep_2019$percep_esfuerzos)
proc_cep_2019$percep_esfuerzos <- set_label(x = proc_cep_2019$percep_esfuerzos,label = "Percepcion de merito esfuerzo")

get_label(proc_cep_2019$percep_inteligencia)
proc_cep_2019$percep_inteligencia <- set_label(x = proc_cep_2019$percep_inteligencia,label = "Percepcion de merito inteligencia y capacidades")

get_label(proc_cep_2019$percep_ambicion)
proc_cep_2019$percep_ambicion <- set_label(x = proc_cep_2019$percep_ambicion,label = "Percepcion de merito ambición")

#### Preferencias merit ####

## recode 
frq(proc_cep_2019$M2_P14_1)
frq(proc_cep_2019$M2_P14_2)
frq(proc_cep_2019$M2_P14_4)


proc_cep_2019$M2_P14_1 <- recode(proc_cep_2019$M2_P14_1, "c(8,9)=NA")
proc_cep_2019$M2_P14_2 <- recode(proc_cep_2019$M2_P14_2, "c(8,9)=NA")
proc_cep_2019$M2_P14_4 <- recode(proc_cep_2019$M2_P14_4, "c(8,9)=NA")

proc_cep_2019$M2_P14_1 <- car::recode(proc_cep_2019$M2_P14_1, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2019$M2_P14_2 <- car::recode(proc_cep_2019$M2_P14_2, "1=5;2=4;3=3;4=2;5=1")
proc_cep_2019$M2_P14_4 <- car::recode(proc_cep_2019$M2_P14_4, "1=5;2=4;3=3;4=2;5=1")

proc_cep_2019$M2_P14_1<-as.numeric(proc_cep_2019$M2_P14_1)
proc_cep_2019$M2_P14_2<-as.numeric(proc_cep_2019$M2_P14_2)
proc_cep_2019$M2_P14_4<-as.numeric(proc_cep_2019$M2_P14_4)

## etiquetado
proc_cep_2019 <- proc_cep_2019 %>% dplyr::rename("pref_responsabilidad"=M2_P14_1, # preferencia meritocracia responsabildad
                                          "pref_educacion" =M2_P14_2, # preferencia meritocracia años educacion
                                          "pref_trabajo" =M2_P14_4) # preferencia meritocracia trabajo bien realizado

get_label(proc_cep_2019$pref_responsabilidad)
proc_cep_2019$pref_responsabilidad <- set_label(x = proc_cep_2019$pref_responsabilidad,label = "Preferencia meritocracia: responsabilidad")

get_label(proc_cep_2019$pref_educacion)
proc_cep_2019$pref_educacion <- set_label(x = proc_cep_2019$pref_educacion,label = "Preferencia meritocracia: educacion")

get_label(proc_cep_2019$pref_trabajo)
proc_cep_2019$pref_trabajo <- set_label(x = proc_cep_2019$pref_trabajo,label = "Preferencia meritocracia: buen trabajo")

#### sexo ####

frq(proc_cep_2019$DS_P1)

proc_cep_2019$DS_P1 <- car::recode(proc_cep_2019$DS_P1, "1=0;2=1")

proc_cep_2019$DS_P1 <- sjlabelled::set_labels(proc_cep_2019$DS_P1,
                                  labels=c( "Hombre"=0,
                                            "Mujer"=1))

proc_cep_2019 <- dplyr::rename(proc_cep_2019,"sexo"=DS_P1)

get_label(proc_cep_2019$sexo)

proc_cep_2019$sexo <- as.factor(proc_cep_2019$sexo)
proc_cep_2019$sexo <- set_label(x = proc_cep_2019$sexo,label = "Sexo")
frq(proc_cep_2019$sexo)

#### edad ####

frq(proc_cep_2019$DS_P2_EXACTA)

proc_cep_2019 <- dplyr::rename(proc_cep_2019,"edad"=DS_P2_EXACTA)

get_label(proc_cep_2019$edad)

proc_cep_2019$edad <- set_label(x = proc_cep_2019$edad,label = "Edad")


#### ingreso ####

## recode
frq(proc_cep_2019$DS_P38)

proc_cep_2019$DS_P38<-as.numeric(proc_cep_2019$DS_P38)

proc_cep_2019$DS_P38 <- car::Recode(proc_cep_2019$DS_P38, "1:7=1;8:10=2;11=3;12:14=4;88:99=5")

#proc_cep_2019$DS_P38 <- recode(proc_cep_2019$DS_P38, "c(88,99)=NA")

## etiquetado
proc_cep_2019 <- proc_cep_2019 %>% dplyr::rename("tramo_ingresos"=DS_P38) # Ingreso en tramos

proc_cep_2019$tramo_ingresos<-as.factor(proc_cep_2019$tramo_ingresos)
proc_cep_2019$tramo_ingresos <- sjlabelled::set_labels(proc_cep_2019$tramo_ingresos,
            labels=c( "Menor al sueldo mínimo"=1,
                      "Sueldo mínimo a 448 mil"=2,
                      "448 mil a 1 millón"=3,
                      "Más de un millón"=4,
                      "NS/NR"=5))

get_label(proc_cep_2019$tramo_ingresos)
proc_cep_2019$tramo_ingresos <- set_label(x = proc_cep_2019$tramo_ingresos,label = "Tramo ingresos entrevistado")

frq(proc_cep_2019$tramo_ingresos)

#### Estatus Social Subjetivo ####

## recode
frq(proc_cep_2019$M2_P13A)
proc_cep_2019$M2_P13A <- recode(proc_cep_2019$M2_P13A, "c(88,99)=NA")


## etiquetado
proc_cep_2019 <- proc_cep_2019 %>% dplyr::rename("ESS"=M2_P13A) # Estatus social subjetivo

get_label(proc_cep_2019$ESS)
proc_cep_2019$ESS <- set_label(x = proc_cep_2019$ESS,label = "Escala ESS")

proc_cep_2019$ESS<-as.numeric(proc_cep_2019$ESS)
frq(proc_cep_2019$ESS)

#### Identificacion politica ####

## recode
frq(proc_cep_2019$MB_P14)

proc_cep_2019$MB_P14<-car::Recode(proc_cep_2019$MB_P14, "1:2=1;3=2;4:5=3;6:9=4")

## etiquetado
proc_cep_2019 <- proc_cep_2019 %>% dplyr::rename("id_politica"=MB_P14) # Identificacion politica

proc_cep_2019$id_politica <- factor(proc_cep_2019$id_politica, labels=c("Derecha","Centro","Izquierda","NS/NR/Ninguno"))

get_label(proc_cep_2019$id_politica)
proc_cep_2019$id_politica <- set_label(x = proc_cep_2019$id_politica,label = "Identificación política")

#### nivel educacional ####

## recode
frq(proc_cep_2019$DS_P4)
proc_cep_2019$DS_P4 <- recode(proc_cep_2019$DS_P4, "c(88,99)=NA")

proc_cep_2019$DS_P4<-car::Recode(proc_cep_2019$DS_P4, "0:2=1;3:4=2;5:9=3")

## etiquetado
proc_cep_2019 <- proc_cep_2019 %>% dplyr::rename("nivel_educ"=DS_P4) # Nivel educacional

proc_cep_2019$nivel_educ <- factor(proc_cep_2019$nivel_educ, labels=c("Básica","Media","Superior"))

get_label(proc_cep_2019$nivel_educ)
proc_cep_2019$nivel_educ <- set_label(x = proc_cep_2019$nivel_educ,label = "Nivel educacional")


proc_cep_2019<-as.data.frame(proc_cep_2019)
stargazer(proc_cep_2019, type="text")

# Agregamos la columna "año"
proc_cep_2019 <- proc_cep_2019 %>%
  mutate(año = 2019)
```

**Descriptivos** 

```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
# Descriptivos 

stargazer(proc_cep_2019, type="text") ## No hay demasiados NA's

## Guardar tabla stargazer
stargazer(proc_cep_2019, type="html",  out = "../Output/Descriptivos_proc_data/descr_tab2019.html")
webshot("descr_tab2019.html","descr_tab2019.png")

## Otra tabla de descriptivos
view(dfSummary(proc_cep_2019, headings=FALSE))
```

## Nueva base de datos para análisis del primer objetivo (2019)

### Atribuciones dicotomizadas

Para el año 2019 se dicotomizan las atribuciones en internas/externas, para posteriormente hacer un analisis de clases latentes (LCA)

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
# Agregamos la columna de atribuciones interna/externa para at de pobreza y riqueza (bbdd con todos los años)

proc_data_2019<-data.table::data.table(proc_cep_2019)

frq(proc_data_2019$at_pobreza1)
proc_data_2019[, Att_p1 := base::ifelse(at_pobreza1 %in% c("La falta de educación", "La flojera y falta de iniciativa", "Los vicios y el alcoholismo"), "atribucion interna",
               base::ifelse(at_pobreza1 %in% c("Las malas políticas econ. del gobierno", "La falta de ayuda económica del gobierno", "Las pocas oportunidades de empleo","La mala suerte","La falta de generocidad de los que tienen más","Porque los padres también eran pobres","Los abusos o injusticias del sistema económico"), "atribucion externa", NA))]

proc_data_2019[, Att_p2 := ifelse(at_pobreza2 %in% c("La falta de educación", "La flojera y falta de iniciativa", "Los vicios y el alcoholismo"), "atribucion interna", 
               ifelse(at_pobreza2 %in% c("Las malas políticas econ. del gobierno", "La falta de ayuda económica del gobierno", "Las pocas oportunidades de empleo","La mala suerte","La falta de generocidad de los que tienen más","Porque los padres también eran pobres","Los abusos o injusticias del sistema económico"), "atribucion externa", NA))]

frq(proc_cep_2019$at_riqueza1)
proc_data_2019[, Att_r1 := ifelse(at_riqueza1 %in% c("El nivel educacional alcanzado", "La iniciativa personal", "El trabajo responsable"), "atribucion interna",
               ifelse(at_riqueza1 %in% c("La fe en dios", "Las ayuda económica del Estado", "Los contactos o 'pitutos' (parientes, amigos)","La situación económica de los padres","Tener una familia unida que apoya","Haciendo dinero a la mala, con manejos deshonestos","La suerte","Las políticas económicas del gobierno"), "atribucion externa", NA))]

proc_data_2019[, Att_r2 := ifelse(at_riqueza2 %in% c("El nivel educacional alcanzado", "La iniciativa personal", "El trabajo responsable"), "atribucion interna",
               ifelse(at_riqueza2 %in% c("La fe en dios", "Las ayuda económica del Estado", "Los contactos o 'pitutos' (parientes, amigos)","La situación económica de los padres","Tener una familia unida que apoya","Haciendo dinero a la mala, con manejos deshonestos","La suerte","Las políticas económicas del gobierno"), "atribucion externa", NA))]

proc_data_2019<-as.data.frame(proc_data_2019)

# Ponemos las etiquetas que faltan

proc_data_2019$ESS <- set_label(x = proc_data_2019$ESS,label = "Estatus social subjetivo")
proc_data_2019$id_politica <- set_label(x = proc_data_2019$id_politica,label = "Identificacion politica")
proc_data_2019$nivel_educ <- set_label(x = proc_data_2019$nivel_educ,label = "Nivel educacional")
proc_data_2019$percep_ambicion <- set_label(x = proc_data_2019$percep_ambicion,label = "Percepcion meritocratica ambicion")

proc_data_2019$Att_p1<-as.factor(proc_data_2019$Att_p1)
proc_data_2019$Att_p2<-as.factor(proc_data_2019$Att_p2)
proc_data_2019$Att_r1<-as.factor(proc_data_2019$Att_r1)
proc_data_2019$Att_r2<-as.factor(proc_data_2019$Att_r2)
proc_data_2019$Att_p1 <- set_label(x = proc_data_2019$Att_p1,label = "Atribucion pob int/ex primera mención")
proc_data_2019$Att_p2 <- set_label(x = proc_data_2019$Att_p2,label = "Atribucion pob int/ex segunda mención")
proc_data_2019$Att_r1 <- set_label(x = proc_data_2019$Att_r1,label = "Atribucion riq int/ex primera mención")
proc_data_2019$Att_r2 <- set_label(x = proc_data_2019$Att_r2,label = "Atribucion riq int/ex segunda mención")
proc_data_2019$año <- set_label(x = proc_data_2019$año,label = "Año")

sum(is.na(proc_data_2019$Att_r2))
```

### Indices de meritocracia (bbdd 2019)

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
# Percepciones

proc_data_2019$pmerit <- (proc_data_2019$percep_inteligencia+proc_data_2019$percep_ambicion+proc_data_2019$percep_esfuerzos)/3

proc_data_2019$pmerit  <- set_label(x = proc_data_2019$pmerit, label = "Percepción meritocracia promedio")

data_percepcion<-proc_data_2019 %>% dplyr::select(percep_ambicion,percep_inteligencia,percep_esfuerzos)

# Preferencias

proc_data_2019$prefmerit <- (proc_data_2019$pref_responsabilidad+proc_data_2019$pref_educacion+proc_data_2019$pref_trabajo)/3

proc_data_2019$prefmerit  <- set_label(x = proc_data_2019$prefmerit, label = "Preferencia meritocracia promedio")

data_preferencia<-proc_data_2019 %>% dplyr::select(pref_responsabilidad,pref_educacion,pref_trabajo)
```

### Crear variables de meritocracia dicotomizadas

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
# Percepcion
proc_data_2019$dico_esfuerzo <- car::recode(proc_data_2019$percep_esfuerzos,"1:3=0;4:5=1")
proc_data_2019$dico_inteligencia <- car::recode(proc_data_2019$percep_inteligencia,"1:3=0;4:5=1")

# Preferencias
frq(proc_data_2019$pref_responsabilidad)

proc_data_2019$dico_pref_responsabilidad <- car::recode(proc_data_2019$pref_responsabilidad,"1:3=0;4:5=1")
proc_data_2019$dico_pref_educacion <- car::recode(proc_data_2019$pref_educacion,"1:3=0;4:5=1")
proc_data_2019$dico_pref_trabajo <- car::recode(proc_data_2019$pref_trabajo,"1:3=0;4:5=1")
```

### Generar variable de atribuciones con tres valores: internas, externas y ambivalentes (bbdd 2019)

Generar variable de atribuciones a partir de clasificación de investigación de Bucca (2016)

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
## Sacar NA en nueva bbdd

data_naomit2019 <- na.omit(proc_data_2019) 
data_naomit2019 <- data_naomit2019 %>% copy_labels_from(proc_data_2019)
## Nueva variable con 3 clases latentes. 

## PRECAUCION: esto es por mientras. Para hacer analisis de clases latentes se recomienda "latent class regression model". Reisar texto de Linzer y Lewis sobre poLCA

### Variable que toma tanto at. de pobreza como de riqueza

data_naomit2019<-data_naomit2019 %>% mutate(attclass =
                     case_when(Att_p1 == "atribucion interna" & 
           Att_p2 == "atribucion interna" &
           Att_r1 == "atribucion interna" &
           Att_r2 == "atribucion interna" ~ "interna", 
                               Att_p1 == "atribucion externa" & 
           Att_p2 == "atribucion externa" &
           Att_r1 == "atribucion externa" &
           Att_r2 == "atribucion externa" ~ "externa",
           TRUE  ~ "ambivalente")
)

### Además se generan dos variables por separado para at. de pobreza y de riqueza

data_naomit2019<-data_naomit2019 %>% mutate(pob_attclass =
                     case_when(Att_p1 == "atribucion interna" & 
           Att_p2 == "atribucion interna" ~ "interna", 
                               Att_p1 == "atribucion externa" & 
           Att_p2 == "atribucion externa" ~ "externa",
           TRUE  ~ "ambivalente")
)

data_naomit2019<-data_naomit2019 %>% mutate(riq_attclass =
                     case_when(Att_r1 == "atribucion interna" & 
           Att_r2 == "atribucion interna" ~ "interna", 
                               Att_r1 == "atribucion externa" & 
           Att_r2 == "atribucion externa" ~ "externa",
           TRUE  ~ "ambivalente")
)
```

Guardar bases de datos

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
# Guardar bbdd

###sum(is.na(proc_data_2019))

save(data_percepcion,file = "../Input/Data_proc/2019/data_percepcion.RData")
save(data_preferencia,file = "../Input/Data_proc/2019/data_preferencia.RData")
save(proc_cep_2019,file = "../Input/Data_proc/2019/proc_cep_2019.RData")
save(proc_data_2019,file = "../Input/Data_proc/2019/proc_data_2019.RData")
save(data_naomit2019,file = "../Input/Data_proc/2019/data_naomit2019.RData")
```




# Unir bases de datos y ajustes finales a la base de datos procesada (2000, 2009 y 2019)

## Agregar variables de atribuciones dicotomizadas para bbdd de los tres años
  
```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
# Unimos bases de datos
proc_cep <- rbind(proc_cep_2000,proc_cep_2009,proc_cep_2019)

# Agregamos la columna de atribuciones interna/externa para at de pobreza y riqueza (bbdd con todos los años)

proc_data<-data.table::data.table(proc_cep)

frq(proc_cep$at_pobreza1)
proc_data[, Att_p1 := base::ifelse(at_pobreza1 %in% c("La falta de educación", "La flojera y falta de iniciativa", "Los vicios y el alcoholismo"), "atribucion interna",
               base::ifelse(at_pobreza1 %in% c("Las malas políticas econ. del gobierno", "La falta de ayuda económica del gobierno", "Las pocas oportunidades de empleo","La mala suerte","La falta de generocidad de los que tienen más","Porque los padres también eran pobres","Los abusos o injusticias del sistema económico"), "atribucion externa", NA))]

proc_data[, Att_p2 := ifelse(at_pobreza2 %in% c("La falta de educación", "La flojera y falta de iniciativa", "Los vicios y el alcoholismo"), "atribucion interna", 
               ifelse(at_pobreza2 %in% c("Las malas políticas econ. del gobierno", "La falta de ayuda económica del gobierno", "Las pocas oportunidades de empleo","La mala suerte","La falta de generocidad de los que tienen más","Porque los padres también eran pobres","Los abusos o injusticias del sistema económico"), "atribucion externa", NA))]


proc_data[, Att_r1 := ifelse(at_riqueza1 %in% c("El nivel educacional alcanzado", "La iniciativa personal", "El trabajo responsable"), "atribucion interna",
               ifelse(at_riqueza1 %in% c("La fe en dios", "Las ayuda económica del Estado", "Los contactos o 'pitutos' (parientes, amigos)","La situación económica de los padres","Tener una familia unida que apoya","Haciendo dinero a la mala, con manejos deshonestos","La suerte","Las políticas económicas del gobierno"), "atribucion externa", NA))]

proc_data[, Att_r2 := ifelse(at_riqueza2 %in% c("El nivel educacional alcanzado", "La iniciativa personal", "El trabajo responsable"), "atribucion interna",
               ifelse(at_riqueza2 %in% c("La fe en dios", "Las ayuda económica del Estado", "Los contactos o 'pitutos' (parientes, amigos)","La situación económica de los padres","Tener una familia unida que apoya","Haciendo dinero a la mala, con manejos deshonestos","La suerte","Las políticas económicas del gobierno"), "atribucion externa", NA))]
frq(proc_data$Att_r2)

proc_data<-as.data.frame(proc_data)

# Ponemos las etiquetas que faltan

proc_data$ESS <- set_label(x = proc_data$ESS,label = "Estatus social subjetivo")
proc_data$id_politica <- set_label(x = proc_data$id_politica,label = "Identificacion politica")
proc_data$nivel_educ <- set_label(x = proc_data$nivel_educ,label = "Nivel educacional")
proc_data$percep_ambicion <- set_label(x = proc_data$percep_ambicion,label = "Percepcion meritocratica ambicion")

proc_data$Att_p1<-as.factor(proc_data$Att_p1)
proc_data$Att_p2<-as.factor(proc_data$Att_p2)
proc_data$Att_r1<-as.factor(proc_data$Att_r1)
proc_data$Att_r2<-as.factor(proc_data$Att_r2)
proc_data$Att_p1 <- set_label(x = proc_data$Att_p1,label = "Atribucion pob int/ex primera mención")
proc_data$Att_p2 <- set_label(x = proc_data$Att_p2,label = "Atribucion pob int/ex segunda mención")
proc_data$Att_r1 <- set_label(x = proc_data$Att_r1,label = "Atribucion riq int/ex primera mención")
proc_data$Att_r2 <- set_label(x = proc_data$Att_r2,label = "Atribucion riq int/ex segunda mención")
proc_data$año <- set_label(x = proc_data$año,label = "Año")


#proc_data[is.na(proc_data)] <- 0
```

## Crear variables de meritocracia dicotomizadas

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
# Percepcion

proc_data$dico_esfuerzo <- car::recode(proc_data$percep_esfuerzos,"1:3=0;4:5=1")
proc_data$dico_inteligencia <- car::recode(proc_data$percep_inteligencia,"1:3=0;4:5=1")

# Preferencias
frq(proc_data$pref_responsabilidad)

proc_data$dico_pref_responsabilidad <- car::recode(proc_data$pref_responsabilidad,"1:3=0;4:5=1")
proc_data$dico_pref_educacion <- car::recode(proc_data$pref_educacion,"1:3=0;4:5=1")
proc_data$dico_pref_trabajo <- car::recode(proc_data$pref_trabajo,"1:3=0;4:5=1")
```

### Ajustes de variables
Por ahora no se trabajará con percepcion meritocratica basado en ambicion (no esta en bbdd 2000)

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
colSums(is.na(proc_data))
proc_data<-subset(proc_data, select = -c(percep_ambicion))
proc_data<-na.omit(proc_data)

# Poner etiquetas faltantes 
proc_data$percep_esfuerzos <- set_label(x = proc_data$percep_esfuerzos,label = "Percepcion de merito esfuerzo")
proc_data$percep_inteligencia <- set_label(x = proc_data$percep_inteligencia,label = "Percepcion de merito inteligencia y capacidades")
proc_data$pref_responsabilidad <- set_label(x = proc_data$pref_responsabilidad,label = "Preferencia meritocracia: responsabilidad")
proc_data$pref_educacion <- set_label(x = proc_data$pref_educacion,label = "Preferencia meritocracia: educacion")
proc_data$pref_trabajo <- set_label(x = proc_data$pref_trabajo,label = "Preferencia meritocracia: trabajo")
```


# Análisis clases latentes

```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
proc_data$Att_p1<-as.factor(proc_data$Att_p1)
proc_data$Att_p2<-as.factor(proc_data$Att_p2)
proc_data$Att_r1<-as.factor(proc_data$Att_r1)
proc_data$Att_r2<-as.factor(proc_data$Att_r2)


f <- cbind(Att_p1,Att_p2,Att_r1,Att_r2)~1

xd <- cbind(at_pobreza1,at_pobreza2)~1

f1 <- cbind(Att_p1,Att_p2)~1
f2 <- cbind(Att_r1,Att_r2)~1
```

## Análisis de dos clases con pob + riq (NO CORRER)

```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
proc_data %>% 
  dplyr::select(starts_with("Att_")) %>%  
  poLCA(f, ., nclass = 2, nrep = 6, graphs = TRUE, maxiter = 5000) -> LCA_2clases # BIC = 21472.32
```


## Análisis de tres clases con pob + riq

```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
proc_data %>% 
  dplyr::select(starts_with("Att_")) %>%  
  poLCA(f, ., nclass = 3, nrep = 6, graphs = TRUE, maxiter = 20000) -> LCA_3clases # BIC = 21464.48; AIC(3): 21376.14
```

### Agregar columna con clases predichas

```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
proc_data <- cbind(proc_data, "pred_atribuciones" = LCA_3clases$predclass)
proc_data$pred_atribuciones<-as.factor(proc_data$pred_atribuciones)
proc_data$pred_atribuciones<-set_label(x=proc_data$pred_atribuciones, label = "Atribuciones 3 clases")
data_predclass_2019$pred_atribuciones <- sjlabelled::set_labels(data_predclass_2019$pred_atribuciones,
            labels=c( "Externa"=1,
                      "Ambivalente"=2,
                      "Interna"=3))
frq(proc_data$pred_atribuciones)
# Variable dependiente "ordinal" para regresión

proc_data %>%
  mutate(pred_atribuciones_ord = ordered(pred_atribuciones)) -> proc_data
```

## Análisis de tres clases pobreza (NO CORRER)

```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
frq(proc_data$at_pobreza1)
proc_data %>% 
  dplyr::select(at_pobreza1,at_pobreza2) %>%  
  poLCA(xd, ., nclass = 3, nrep = 10, graphs = TRUE, maxiter = 100000) -> LCA_3clases # BIC = 
```

## Análisis de tres clases riqueza (NO CORRER)

```{r echo=FALSE, results='asis',warning=FALSE, message=FALSE}
proc_data %>% 
  dplyr::select(starts_with("Att_")) %>%  
  poLCA(f, ., nclass = 3, nrep = 6, graphs = TRUE, maxiter = 5000) -> LCA_3clases # BIC = 21464.48
```


# Guardar bbdd

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
## unir bases de datos

save(proc_cep,file = "../Input/Data_proc/proc_cep.RData")
save(proc_data,file = "../Input/Data_proc/proc_data.RData")
```