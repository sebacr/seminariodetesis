```{r include=FALSE}
pacman::p_load(dplyr, kableExtra, psych, psy, nFactors, summarytools, sjlabelled, sjmisc, car, corrplot, polycor, GPArotation, nortest, tseries, lavaan, palmerpenguins, tibble,sjPlot, ggpubr,knitr,gtsummary,fastDummies,ordinal,texreg,stargazer,MASS,poLCA)
load("Input/Data_proc/proc_cep.RData")
load("Input/Data_proc/proc_data.RData")
```

```{r message=FALSE, warning=FALSE, include=FALSE}
# Functions for factorial anaysis tables
fa_table <- function(x, cut) {
  #get sorted loadings
  loadings <- fa.sort(x)$loadings %>% round(3)
  #supress loadings
  loadings[loadings < cut] <- ""
  #get additional info
  add_info <- cbind(x$communality, 
                    x$uniquenesses,
                    x$complexity) %>%
    # make it a data frame
    as.data.frame() %>%
    # column names
    rename("Communality" = V1,
           "Uniqueness" = V2,
           "Complexity" = V3) %>%
    #get the item names from the vector
    rownames_to_column("item")
  #build table
  loadings %>%
    unclass() %>%
    as.data.frame() %>%
    rownames_to_column("item") %>%
    left_join(add_info) %>%
    mutate(across(where(is.numeric), round, 3))
}
```

```{r include=FALSE}
table_format = if(is_html_output()) {
  "html"
} else if(is_latex_output()) {
  "latex"
}

table_format2 = if(is_html_output()) {
  T
} else if(is_latex_output()) {
  F
}
```

# Análisis

## Análisis descriptivo

### Variable dependiente

<div style="text-align: justify">

```{r include=FALSE}
furniture::table1(proc_data,
  "Primera mención Atribuciones de pobreza" = Att_p1, "Segunda mención Atribuciones de pobreza" = Att_p2,bold = TRUE,
  splitby = ~año,
  test = TRUE,
  na.rm = FALSE,
  format_number = TRUE) -> tab_pob

furniture::table1(proc_data,
  "Primera mención Atribuciones de riqueza" = Att_r1, "Segunda mención Atribuciones de riqueza" = Att_r2,bold = TRUE,
  splitby = ~año,
  test = TRUE,
  na.rm = FALSE,
  format_number = TRUE) -> tab_riq

furniture::table1(proc_data,
  "Percepcion de merito esfuerzo" = percep_esfuerzos, "Percepcion de merito inteligencia y capacidades" = percep_inteligencia,"Preferencia meritocracia: responsabilidad" = pref_responsabilidad,"Preferencia meritocracia: educacion" = pref_educacion,"Preferencia meritocracia: trabajo duro" = pref_trabajo,bold = TRUE,
  splitby = ~año,
  test = TRUE,
  na.rm = FALSE,
  format_number = TRUE) -> tab_merit

cap3 <- "Atribuciones de pobreza"
cap4 <- "Atribuciones de riqueza"
cap5 <- "Percepciones y preferencias meritocraticas en el tiempo"
```

```{r tab-descpob, echo=FALSE}
kbl(tab_pob,table_format, caption = cap3, "html", booktabs = T) %>%
kable_styling(
    full_width = T,
    latex_options = c("hold_position"),
    position = "center",
    font_size = 16,
    bootstrap_options=c("striped", "bordered")) %>%
  add_header_above(c("Respuestas"=1, "Descrpitivos" = 3),bold = T)  %>%
  column_spec(column = 1, width = "4 cm", ) %>%
  column_spec(column = 2,width = "2 cm") %>%
  column_spec(column = 3,width = "2 cm") %>%
  column_spec(column = 4,width = "2 cm") #%>%
#  save_kable("../Output/Tablas/atribuciones_pobreza_interna_externa.html")
```

En la Tabla N° \@ref(tab:tab-descpob) se observan descriptivos univariados de las atribuciones de pobreza en los años 2000, 2009 y 2019. Sobre la primera mención en atribuciones, se observa una caída en el porcentaje de respuesta sobre atribuciones internas del 2000 al 2009, en donde para el año 2000 un 75,8% mencionó una atribución interna en su primera mención, mientras que para el 2009 lo hizo un 59,9%. Sin embargo, las respuestas en atribuciones internas vuelven a subir para el año 2019, siendo el porcentaje de respuestas internas para este año un 65,9%. Respecto a la segunda mención, se destacan dos tendencias en las respuestas: en primer lugar, las atribuciones internas experimentan un aumento sostenido en el 2000, 2009 y 2019, en donde se observa que los porcentajes de respuesta son de un 26,9%, 47,8% y 49,% respectivamente. En segundo lugar, existe una tendencia a la disminución en las atribuciones externas, siendo de un 73,1% para el 2000, 52,2% para el 2009 y de 50,8% para el 2019. 


```{r tab-descriq, echo=FALSE}
kbl(tab_riq,table_format, caption = cap4, "html", booktabs = T) %>%
kable_styling(latex_options = c("striped", "HOLD_position"),font_size = 16,
    bootstrap_options=c("striped", "bordered")) %>%
  add_header_above(c("Respuestas"=1, "Descrpitivos" = 3),bold = T)  %>%
  column_spec(column = 1, width = "4 cm", ) %>%
  column_spec(column = 2,width = "2 cm") %>%
  column_spec(column = 3,width = "2 cm") %>%
  column_spec(column = 4,width = "2 cm") #%>%
#  save_kable("../Output/Tablas/atribuciones_pobreza_interna_externa.html")
```

Respecto de las atribuciones de riqueza, en la Tabla N° \@ref(tab:tab-descriq) se pueden observar los porcentajes de respuesta entre atribuciones internas y externas para los años 2000, 2009 y 2019. Sobre la primera mención de atribuciones, se observa un patrón en donde se mantienen relativamente estables los procentajes de respuesta a lo largo de los tres años tanto para atribuciones internas como externas. Un elemento a destacar es que para los tres años las respuestas internas son considerablemente más altas a las externas, siendo las primeras casi el doble respecto de las segundas. Sobre la segunda mención, se observan cambios entre el año 2000 y 2009, pero se mantienen estables entre 2009 y 2019. De manera más específica, las atribuciones externas disminuyen de 59,3% a un 46,2% entre el 2000 y el 2009, pero para el 2019 se mantiene relativamente estable, presentando un 46,8% de las respuestas. Por el otro lado, en cuanto a las atribuciones internas, se observa un aumento de respuestas entre el 2000 y el 2009, pasando de un 40,7% a un 53,8%, respectivamente, pero se mantiene en un 53,2% para el 2019.

### Analisis de clases latentes

<div style="text-align: justify">

Para la selección de clases se consideraron los estadísticos BIC y AIC, en donde los valores más bajos indicarían un mejor de ajuste de las clases respecto de las observaciones reales (CITAR). Bajo esta premisa, los modelos LCA con mejores resultados fueron de dos y tres clases. Para el modelo de dos clases se obtuvo un BIC de 21472.32 y un AIC de 21415.53. Para el modelo de tres clases se obtuvo un BIC de 21464.48 y un AIC de 21376.14. Con más de tres clases los modelos comienzan a presentar problemas. 

Si bien el estadístico BIC presenta mejores resultados para el modelo de dos clases, tanto el estadístico BIC como AIC presentan resultados similares para el modelo de dos y tres clases, siendo incluso mayor los resultados del AIC para el modelo de tres clases. En este sentido, la elección del modelo de tres clases se fundamenta primordialmente en los antecedentes sobre atribuiciones de pobreza y riqueza, la cual apunta a la existencia de tres categorías, siendo estas las clases externas, ambivalentes e internas. Además ello entrega más herramientas para la posterior comparación entre investigaciones.

```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
proc_data$Att_p1<-as.factor(proc_data$Att_p1)
proc_data$Att_p2<-as.factor(proc_data$Att_p2)
proc_data$Att_r1<-as.factor(proc_data$Att_r1)
proc_data$Att_r2<-as.factor(proc_data$Att_r2)
f <- cbind(Att_p1,Att_p2,Att_r1,Att_r2)~1

proc_data %>% 
  dplyr::select(starts_with("Att_")) %>%  
  poLCA(f, ., nclass = 3, nrep = 6, graphs = FALSE, maxiter = 20000) -> LCA_3clases # BIC = 21464.48
frq(proc_data$pred_atribuciones)
```

```{r classes,echo=FALSE, fig.cap="Correlaciones de Pearson para percepciones y preferencias meritocráticas", fig.align = 'center',results='asis',warning=FALSE, message=FALSE}
plot(LCA_3clases)
```

En la Figura N° \@ref(fig:classes) se resume el modelo de tres clases. Posterior a la creación del modelo, se extraen las clases predichas para cada observación, siendo esta la variable dependiente final para los posteriores modelos.

### Variables independientes

<div style="text-align: justify">

```{r tab-descmerit1, echo=FALSE, results='asis'}
basecor<- proc_data %>% dplyr::select(percep_esfuerzos,percep_inteligencia,pref_responsabilidad,pref_educacion,pref_trabajo)

dfsum<- dfSummary(basecor,
               plain.ascii = FALSE,
               style = "grid",
               tmp.img.dir = "./tmp",
               graph.magnif = 0.75,
               headings = F,  # encabezado
               varnumbers = F, # num variable
               labels.col = T, # etiquetas
               na.col = F,    # missing
               graph.col = F, # plot
               valid.col = FALSE, # n valido
               col.widths = c(5,10,10,10,10)
               )
dfsum$Variable <- NULL # delete variable column

print(dfsum)
```

En la tabla anterior se observan los descriptivos para las variables de percepción y preferencias meritocráticas. Para las percepciones, en donde se responde en una escala del 1 al 5 sobre la importancia de (1) el trabajo duro para surgir en la vida y (2) el tener un buen nivel de educación para surgir en la vida, se observa en ambas variables una media superior a 3, lo cual indica una tendencia media-alta en la percepción meritocrática en la sociedad chilena. Para las preferencias meritocráticas, en donde se responde con la misma escala de importancia a la pregunta cuán importante debería ser (1) el nivel de responsabilidad en el trabajo, (2) los años dedicados a educación y capacitacion y (3) lo bien que realiza su trabajo al momento de decidirse cuánto debería ganar la gente. Para las tres variables se tiene una media de 4, por lo que existe cierto consenso en la población en la preferencia de mecanismos meritocráticos a la hora de decidir las ganancias monetarias de la gente. 

Se debe destacar que las percepciones meritocráticas presentan una desviación estándar (sd) más alta que para el caso de las preferencias meritocráticas. Con esto se puede concluir que existe mayor homogeneidad a la hora de responder sobre las preguntas de preferencia meritocrática, respecto de las percepciones meritocráticas.


```{r tab-descmerit2, echo=FALSE}


kbl(tab_merit,table_format, caption = cap5, "html", booktabs = T) %>%
kable_styling(latex_options = c("striped", "HOLD_position"),font_size = 16,
    bootstrap_options=c("striped", "bordered")) %>%
  add_header_above(c("Respuestas"=1, "Descrpitivos" = 3),bold = T)  %>%
  column_spec(column = 1, width = "4 cm", ) %>%
  column_spec(column = 2,width = "2 cm") %>%
  column_spec(column = 3,width = "2 cm") %>%
  column_spec(column = 4,width = "2 cm") #%>%
#  save_kable("../Output/Tablas/atribuciones_pobreza_interna_externa.html")
```

En la Tabla N° \@ref(tab:tab-descmerit2) se observan la media seguida de la desviasión estándar entre paréntesis para las variables independientes en los tres años. De dicha tabla se destaca un aumento en las percepciones meritocráticas entre el año 2000 y el 2009, pasando de un 2,9 a un 3,8 en la variable de percepción meritocrática basado en el esfuerzo, y de un 2,9 a un 4,1 en la percepción meritocrática basado en inteligencia y capacidades. En el año 2019 las medias se mantiene relativamente estables respecto de la fecha anterior, en donde ambas variables presentan una media de 3,8. 

Para el caso de las preferencias meritocráticas, las tres variables se mantienen estables a lo largo de los años 2000, 2009 y 2019, con valores cercanos al 4.


```{r matpearson, echo=FALSE, fig.cap="Correlaciones de Pearson para percepciones y preferencias meritocráticas", fig.align = 'center', out.width = '100%', results='asis'}

cormat=cor(basecor, use = "complete.obs")

windowsFonts(A = windowsFont("Times New Roman"))
rownames(cormat) <-c(
    "(1) Percepción meritocratica basado en esfuerzo",
    "(2) Percepción meritocratica basado en inteligencia y capacidades",
    "(3) Preferencias meritocraticas basado en nivel de responsabilidad", 
    "(4) Preferencias meritocraticas basado en educacion",
    "(5) Preferencias meritocraticas basado en lo bien que se realiza el trabajo"
    )
    
    
colnames(cormat) <-c("(1)", "(2)","(3)","(4)","(5)")


corrplot(cormat,
  method = "color",
  type = "upper",
  tl.col = "black",
  addCoef.col = "black",
  diag = TRUE,
  family = "A",
  number.font = 6,
  tl.cex =0.75,
  number.cex = 1)

```

En la Figura N° \@ref(fig:matpearson) se observan las correlaciones de pearson entre las variables independientes. Los niveles de correlación entre las variables de percepción meritocrática basada en el esfuerzo y percepción meritocrática basado en inteligencia y capacidades son positivas y medias-altas. De lo anterior se puede concluir que pertenecen a un mismo constructo (o que al menos se diferencian del constructo de preferencias meritocráticas, con las cuales tienen una correlación casi nula), pero que de todas maneras vale la pena considerar ambas variables por separadas en un posible modelo de regresión. Por otra parte, las tres variables de preferencias meritocráticas también presentan niveles de correlación positivas y medianas entre ellas. Ello indica una posible pertenencia al mismo constructo de preferencias meritocráticas, pero al igual que con las percecpiones, es conveniente considerar la influencia de las tres variables por separado sobre la variable dependiente.

## Análisis multivariado

<div style="text-align: justify">

Considerando los avances presentados en la sección de análisis descriptivo, al aplicar el modelo de regresión se asume que tanto el valor esperado de Y -variable dependiente- como de la relación entre X e Y varían en el tiempo. Debido a que los datos se agrupan como datos agrupados de sección transversal -pooled cross sectional data- y basándonos en la evidencia del manual de @wooldridge_introductory_2013, no se aplicarán efectos fijos o efectos aleatorios. En este sentido, para el caso en que observaciones no se repiten en los diferentes años, se recomienda el método de Mínimos Cuadrados Ordinarios (MCO) agrupados -o en inglés 'pooled OLS'-. 


```{r echo=FALSE, results='hide',warning=FALSE, message=FALSE}
proc_data$pred_atribuciones<-as.factor(proc_data$pred_atribuciones)
proc_data$año<-as.factor(proc_data$año)
# Dummy para cada año

proc_data <- dummy_cols(proc_data,select_columns = "año")

model0 <- clm(pred_atribuciones ~ percep_inteligencia+percep_esfuerzos + pref_responsabilidad + pref_educacion + pref_trabajo + sexo + ESS, data=proc_data)
```
```{r echo=TRUE, results='hide',warning=FALSE, message=FALSE}
model1 <- clm(pred_atribuciones ~ año_2009*(percep_inteligencia+percep_esfuerzos) + año_2019*(percep_inteligencia+percep_esfuerzos) + pref_responsabilidad + pref_educacion + pref_trabajo + sexo + ESS, data=proc_data)
```

```{r tab-reg, echo=FALSE, results='asis',warning=FALSE}
htmlreg(model1)
```

El modelo anterior [^2] es un primer acercamiento a una regresión ordinal con cambios en el intercepto y en la relación entre variables independientes y dependiente. Debido a que no es el modelo definitivo, la interpretación se ve postergada. Sin embargo, la nula significancia obtenida de los coeficientes de las variables independientes nos indican que por el momento la hipótesis alternativa no se cumple. Por otra parte, existe significancia en las variables correspondientes al tiempo (año 2009 y 2019), lo cual indica una variación de la variable dependiente a lo largo del tiempo.

Se espera una interpretación más sustantiva para el modelo definitivo a utilizar. [^3]

[^2]: Hay una serie de decisiones tomadas tras el modelo que me gustaría discutir. Primero algunas dudas a raíz de que no encontré ejemplos reproducibles de regresiones ordinales con pooled data. Para regresión ordinal conozco las librerías MMCO y ordinal, mientras que la librería que conozco para pooled OLS es plm, la cual da la opción de especificar model = 'pooling'. Las dudas son (a) no estoy seguro de si la variación de los coeficientes por año está bien ingresada en el código. Esto lo hice basado en ejemplos reproducibles de pooled OLS con variable dependiente continua -ejemplo en Wooldridge (2010, pág. 451)-. (b) Debido a que en el ejemplo de Wooldridge se trabaja con dos años, no estoy seguro de si es adecuada la operacionalización como dummies de los tres años (es decir, si es correcto simplemente omitir el año 2000 para considerarlo como variable referencia/intercepto cuando 2009 y 2019 son 0). 

[^3]: La visualización de tablas y gráficos tampoco es la definitiva.